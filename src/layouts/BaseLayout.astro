---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Seo from '../components/Seo.astro';
import CookieBanner from '../components/CookieBanner.astro';
import { getNavigation, getSiteSettings } from '../lib/sanityQueries';

const { seo } = Astro.props;
const [navigation, settings] = await Promise.all([
  getNavigation(),
  getSiteSettings()
]);
const meta = {
  title: seo?.title ?? settings?.title ?? 'Reflexive Coherence Model',
  description:
    seo?.description ??
    settings?.description ??
    'Independent research collective exploring the Reflexive Coherence Model.',
  canonicalUrl: seo?.canonicalUrl,
  image: seo?.image
};
---
<html lang="en" class="scroll-smooth">
  <head>
    <Seo {...meta} />
    <script is:inline>
      (() => {
        const storageKey = 'cm-theme';
        const root = document.documentElement;
        const themes = ['light', 'dark', 'accessible'];
        const applyTheme = (theme) => {
          root.classList.toggle('dark', theme === 'dark');
          root.classList.toggle('theme-accessible', theme === 'accessible');
        };
        try {
          const stored = localStorage.getItem(storageKey);
          if (stored && themes.includes(stored)) {
            applyTheme(stored);
            return;
          }
        } catch (error) {}
        const prefersDark = window.matchMedia
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false;
        applyTheme(prefersDark ? 'dark' : 'light');
      })();
    </script>
    <script is:inline>
      (() => {
        if (typeof window === 'undefined' || typeof document === 'undefined') return;
        const root = document.documentElement;
        if (!root) return;

        const setViewportUnit = () => {
          const vh = window.innerHeight * 0.01;
          root.style.setProperty('--cm-vh', `${vh}px`);
        };

        let raf = null;
        const scheduleUpdate = () => {
          if (raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(() => {
            setViewportUnit();
            raf = null;
          });
        };

        setViewportUnit();
        window.addEventListener('resize', scheduleUpdate);
        window.addEventListener('orientationchange', scheduleUpdate);
        document.addEventListener('astro:after-swap', setViewportUnit);

        window.addEventListener(
          'pagehide',
          () => {
            window.removeEventListener('resize', scheduleUpdate);
            window.removeEventListener('orientationchange', scheduleUpdate);
            document.removeEventListener('astro:after-swap', setViewportUnit);
            if (raf) cancelAnimationFrame(raf);
          },
          { once: true }
        );
      })();
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900 transition-colors duration-300 dark:bg-slate-950 dark:text-slate-100">
    <a
      href="#content"
      class="sr-only focus:not-sr-only focus:absolute focus:m-4 focus:rounded focus:bg-slate-200 focus:px-4 focus:py-2 focus:text-slate-900"
    >
      Skip to content
    </a>
    <Header navigation={navigation ?? []} />
    <main
      id="content"
      class="min-h-[100svh] min-h-[100dvh]"
      style="min-height: calc(var(--cm-vh, 1vh) * 100);"
    >
      <slot />
    </main>
    <Footer siteTitle={settings?.title ?? 'Reflexive Coherence Lab'} />
    <CookieBanner />
    <script is:inline>
      (() => {
        if (typeof document === 'undefined') return;

        const storageKey = 'cm-theme';
        const root = document.documentElement;
        const themes = ['light', 'dark', 'accessible'];

        const getCurrentTheme = () => {
          if (root.classList.contains('theme-accessible')) return 'accessible';
          if (root.classList.contains('dark')) return 'dark';
          return 'light';
        };

        const applyClasses = (theme) => {
          root.classList.toggle('dark', theme === 'dark');
          root.classList.toggle('theme-accessible', theme === 'accessible');
          if (theme !== 'dark') {
            root.classList.remove('dark');
          }
          if (theme !== 'accessible') {
            root.classList.remove('theme-accessible');
          }
        };

        const syncToggles = (theme) => {
          document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
            btn.setAttribute('data-theme', theme);
            btn.setAttribute('aria-pressed', theme === 'light' ? 'false' : 'true');
            const label = btn.querySelector('[data-theme-label]');
            if (label) {
              const text = theme === 'accessible' ? 'Accessibility+' : theme === 'dark' ? 'Dark' : 'Light';
              label.textContent = text;
            }
          });
        };

        const setTheme = (theme) => {
          const nextTheme = themes.includes(theme) ? theme : 'light';
          applyClasses(nextTheme);
          syncToggles(nextTheme);
          try {
            localStorage.setItem(storageKey, nextTheme);
          } catch (error) {}
        };

        const init = () => {
          const current = getCurrentTheme();
          applyClasses(current);
          syncToggles(current);

          document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
            btn.addEventListener('click', () => {
              const currentTheme = getCurrentTheme();
              const nextIndex = (themes.indexOf(currentTheme) + 1) % themes.length;
              const next = themes[nextIndex];
              setTheme(next);
            });
          });
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>
