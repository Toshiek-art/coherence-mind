---
import Nav from './Nav.astro';
import ThemeToggle from './ThemeToggle.astro';
import type { NavigationLink } from '../lib/types';

const { navigation = [] as NavigationLink[] } = Astro.props;
const navItems = navigation ?? [];
---
<header class="relative border-b border-slate-200/90 bg-white/80 text-slate-900 backdrop-blur dark:border-slate-800/80 dark:bg-ink/80 dark:text-slate-100">
  <div class="container flex items-center justify-between gap-4 py-5">
    <a class="text-lg font-semibold tracking-wide" href="/">Coherence Mind</a>

    {/* Desktop navigation */}
    <div class="hidden items-center gap-4 lg:flex">
      <Nav links={navItems} />
      <ThemeToggle />
    </div>

    {/* Mobile controls */}
    <div class="flex items-center gap-3 lg:hidden">
      <ThemeToggle />
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-700 transition hover:border-slate-400 hover:text-slate-900 dark:border-slate-600 dark:text-slate-200 dark:hover:border-slate-400"
        aria-controls="mobileNav"
        aria-expanded="false"
        data-mobile-toggle
      >
        <span class="sr-only">Toggle navigation</span>
        <span class="sr-only">Menu</span>
        <span aria-hidden="true" class="inline-flex h-5 w-5 items-center justify-center">
          <svg
            data-icon-open
            class="h-5 w-5 text-slate-700 dark:text-slate-200"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16" />
          </svg>
          <svg
            data-icon-close
            class="hidden h-5 w-5 text-slate-700 dark:text-slate-200"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" />
          </svg>
        </span>
      </button>
    </div>
  </div>

  {/* Mobile flyout */}
  <div
    id="mobileNav"
    class="border-t border-slate-200 bg-white/95 text-slate-900 shadow-lg dark:border-white/10 dark:bg-ink/95 dark:text-white lg:hidden"
    hidden
  >
    <div class="container py-6">
      <Nav links={navItems} layout="stacked" />
    </div>
  </div>

  <script is:inline>
    (() => {
      if (typeof document === 'undefined') return;

      const init = () => {
        const toggle = document.querySelector('[data-mobile-toggle]');
        const menu = document.getElementById('mobileNav');
        if (!toggle || !menu) return;

        const body = document.body;
        const iconOpen = toggle.querySelector('[data-icon-open]');
        const iconClose = toggle.querySelector('[data-icon-close]');
        let isOpen = false;

        const logBodyState = (label, openState) => {
          const stateLabel = `${label}::${openState ? 'open' : 'closed'}`;
          if (!body) {
            console.log('[mobile-nav]', stateLabel, {
              menuOpen: openState,
              bodyPresent: false
            });
            return;
          }
          const computed = window.getComputedStyle(body);
          console.log('[mobile-nav]', stateLabel, {
            menuOpen: openState,
            bodyInlineOverflow: body.style.overflow || '(inline not set)',
            bodyComputedOverflowX: computed?.overflowX,
            bodyComputedOverflowY: computed?.overflowY,
            bodyClassList: body.className
          });
        };

        const setState = (open, reason = 'manual', force = false) => {
          if (!force && open === isOpen) {
            logBodyState(`${reason}:noop`, open);
            return;
          }
          isOpen = open;
          menu.hidden = !open;
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          toggle.setAttribute('data-menu-state', open ? 'open' : 'closed');
          if (iconOpen && iconClose) {
            iconOpen.classList.toggle('hidden', open);
            iconClose.classList.toggle('hidden', !open);
          }
          if (body) {
            body.classList.toggle('overflow-hidden', open);
            if (!open) {
              body.classList.remove('overflow-hidden');
            }
          }
          logBodyState(reason, open);
        };

        const handleToggle = () => setState(!isOpen, 'toggle');
        const handleMenuClick = (event) => {
          const link = event.target && event.target.closest ? event.target.closest('a') : null;
          if (link) setState(false, 'link-click');
        };
        const handleKeydown = (event) => {
          if (event.key === 'Escape') setState(false, 'escape');
        };

        toggle.addEventListener('click', handleToggle);

        menu.addEventListener('click', handleMenuClick);

        document.addEventListener('keydown', handleKeydown);

        const media = window.matchMedia('(min-width: 1024px)');
        const handleMedia = (event) => {
          if (event.matches) setState(false, 'media');
        };

        if (typeof media.addEventListener === 'function') {
          media.addEventListener('change', handleMedia);
        } else {
          media.onchange = handleMedia;
        }

        const cleanup = () => {
          setState(false, 'cleanup', true);
          toggle.removeEventListener('click', handleToggle);
          menu.removeEventListener('click', handleMenuClick);
          document.removeEventListener('keydown', handleKeydown);
          if (typeof media.removeEventListener === 'function') {
            media.removeEventListener('change', handleMedia);
          } else {
            media.onchange = null;
          }
          window.removeEventListener('pagehide', cleanup);
          window.removeEventListener('beforeunload', cleanup);
          document.removeEventListener('astro:before-swap', cleanup);
          logBodyState('cleanup-complete', false);
        };

        window.addEventListener('pagehide', cleanup);
        window.addEventListener('beforeunload', cleanup);
        document.addEventListener('astro:before-swap', cleanup);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
</header>
