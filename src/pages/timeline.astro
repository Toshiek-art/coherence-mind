---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageTitle from '../components/PageTitle.astro';
import TimelineItem from '../components/TimelineItem.astro';
import { getTimeline } from '../lib/sanityQueries';
import type { TimelineEvent } from '../lib/types';

const eventsRaw = ((await getTimeline()) ?? []) as TimelineEvent[];

const seo = {
  title: 'Timeline — CoherenceMind',
  description:
    'A conceptual timeline outlining the emergence, formalization, and publication of the Reflexive Coherence Model (2022–2025).'
};

// Helpers
const getYear = (event: TimelineEvent): number | null => {
  if (typeof event?.year === 'number') return event.year;
  if (event?.date) {
    const d = new Date(event.date);
    const y = d.getFullYear();
    return Number.isFinite(y) ? y : null;
  }
  return null;
};

const START_YEAR = 2022;
const END_YEAR = 2025;

// Keep only events with a valid year inside range
type TimelineEventWithYear = TimelineEvent & { __year: number };

const events: TimelineEventWithYear[] = eventsRaw
  .map((ev) => ({ ...ev, __year: getYear(ev) }))
  .filter((ev): ev is TimelineEventWithYear => {
    const year = ev.__year;
    return typeof year === 'number' && year >= START_YEAR && year <= END_YEAR;
  });

// Group events by year (descending)
type TimelineGroup = { year: number; items: TimelineEventWithYear[] };

const groupsMap = events.reduce<Record<number, TimelineGroup>>((acc, ev) => {
  const year = ev.__year;
  if (!acc[year]) {
    acc[year] = { year, items: [] };
  }
  acc[year].items.push(ev);
  return acc;
}, {});

const groups: TimelineGroup[] = Object.values(groupsMap).sort((a, b) => b.year - a.year);

// Optional: ensure stable order inside each year if there is a date
for (const group of groups) {
  group.items.sort((a, b) => {
    const ad = a?.date ? new Date(a.date).getTime() : 0;
    const bd = b?.date ? new Date(b.date).getTime() : 0;
    return bd - ad; // most recent first within year
  });
}
---
<BaseLayout seo={seo}>
  <PageTitle
    eyebrow="history"
    title="Timeline"
    intro="A conceptual timeline documenting how the Reflexive Coherence Model acquired a distinct theoretical and formal structure."
  />

  <section class="pb-20">
    <div class="container">
      {/* Method note */}
      <div class="mb-10 rounded-2xl border border-slate-200 bg-white/60 p-6 text-slate-700 shadow-sm backdrop-blur dark:border-white/10 dark:bg-white/5 dark:text-white/75">
        <h2 class="mb-2 text-sm font-semibold tracking-wide text-slate-900 dark:text-white">
          Method note
        </h2>
        <p class="text-sm leading-relaxed">
          This page focuses on the period <span class="font-semibold">2022–2025</span>, when the Reflexive Coherence Model (RCM)
          took a distinct theoretical and formal shape. Earlier exploratory phases and later extensions are intentionally excluded.
          The goal is to clarify the internal development of the model — not to document personal history or applications.
        </p>
      </div>

      {groups.length ? (
        <>
          {/* Mobile year chips */}
          <nav class="mb-10 lg:hidden" aria-label="Timeline years">
            <div class="flex gap-2 overflow-x-auto pb-2">
              {groups.map((g) => (
                <a
                  href={`#year-${g.year}`}
                  class="shrink-0 rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm backdrop-blur hover:bg-white dark:border-white/10 dark:bg-white/5 dark:text-white/75 dark:hover:bg-white/10"
                >
                  {g.year}
                </a>
              ))}
            </div>
          </nav>

          <div class="grid gap-12 lg:grid-cols-[140px_1fr]">
            {/* LEFT: sticky years (desktop) */}
            <aside class="hidden lg:block">
              <div class="sticky top-28 space-y-3">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-white/50">
                  On this page
                </div>
                {groups.map((g) => (
                  <a
                    href={`#year-${g.year}`}
                    class="block rounded-xl px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100/70 hover:text-slate-900 dark:text-white/60 dark:hover:bg-white/10 dark:hover:text-white"
                  >
                    {g.year}
                  </a>
                ))}

                <a
                  href="#top"
                  class="mt-4 inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-semibold text-slate-500 hover:bg-slate-100/70 hover:text-slate-900 dark:text-white/50 dark:hover:bg-white/10 dark:hover:text-white"
                >
                  Back to top
                </a>
              </div>
            </aside>

            {/* RIGHT: timeline */}
            <div class="relative" id="top">
              {/* vertical line */}
              <div class="absolute left-3 top-0 h-full w-px bg-slate-200 dark:bg-white/10" />

              <div class="space-y-16">
                {groups.map((group) => (
                  <section id={`year-${group.year}`} class="relative scroll-mt-28">
                    {/* year header */}
                    <div class="mb-6 flex items-center gap-4">
                      <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full border border-slate-300 bg-white shadow-sm dark:border-white/20 dark:bg-slate-900">
                        <div class="h-2 w-2 rounded-full bg-slate-500 dark:bg-white/60" />
                      </div>
                      <h2 class="text-base font-semibold text-slate-900 dark:text-white">
                        {group.year}
                      </h2>
                    </div>

                    {/* events */}
                    <div class="ml-8 space-y-8">
                      {group.items.map((event) => (
                        <TimelineItem event={event} />
                      ))}
                    </div>
                  </section>
                ))}
              </div>

              {/* Closing note */}
              <div class="mt-14 rounded-2xl border border-slate-200 bg-white/60 p-6 text-slate-700 shadow-sm backdrop-blur dark:border-white/10 dark:bg-white/5 dark:text-white/75">
                <h2 class="mb-2 text-sm font-semibold tracking-wide text-slate-900 dark:text-white">
                  Scope
                </h2>
                <p class="text-sm leading-relaxed">
                  This timeline documents the internal development of the model. Exploratory extensions and open questions are discussed elsewhere,
                  primarily within the <a href="/notes" class="font-semibold underline underline-offset-4 hover:opacity-80">Notes</a> section.
                </p>
              </div>
            </div>
          </div>
        </>
      ) : (
        <div class="rounded-2xl border border-slate-200 bg-white/60 p-6 text-slate-600 shadow-sm backdrop-blur dark:border-white/10 dark:bg-white/5 dark:text-white/70">
          Timeline entries will be published soon.
        </div>
      )}
    </div>
  </section>
</BaseLayout>
