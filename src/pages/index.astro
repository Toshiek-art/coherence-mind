---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getHomepageData } from '../lib/sanityQueries';
import RichTextRenderer from '../components/RichTextRenderer';

const data = await getHomepageData();
const heroDoc = data?.hero;
const heroTitle = heroDoc?.heroTitle ?? 'Coherence Mind';
const heroSubtitle =
  heroDoc?.heroSubtitle ??
  'A research space for the Reflexive Coherence Model — a modular framework charting how consciousness builds, stabilises and reflects on itself.';
const heroDisclaimer = heroDoc?.heroDisclaimer;
const scopeEpistemicStatus = heroDoc?.scopeEpistemicStatus;
const seo = {
  title: heroTitle,
  description: heroSubtitle
};

const baseAnchors = [
  { id: 'overview', label: 'Overview' },
  { id: 'model', label: 'RCM reveals' },
  { id: 'structure', label: 'Structure' },
  { id: 'ecosystem', label: 'Ecosystem' },
  { id: 'notes', label: 'Lab notes' },
  { id: 'manifesto', label: 'Manifesto' }
];

const anchors = scopeEpistemicStatus
  ? [...baseAnchors, { id: 'scope', label: 'Scope & status' }]
  : baseAnchors;

const reflexiveLayers = [
  {
    initial: 'R',
    title: 'Reflexive structure',
    description: 'The system builds an internal model of its own informational state.',
    accent: 'border-sky-700/70 text-sky-800 dark:text-sky-300'
  },
  {
    initial: 'C',
    title: 'Coherence dynamics',
    description: 'Integration tends toward stable patterns of internal consistency.',
    accent: 'border-violet-700/70 text-violet-800 dark:text-violet-300'
  },
  {
    initial: 'E',
    title: 'Expansion hypothesis',
    description: 'Stable systems expand their reflexive scope when equilibrium holds.',
    accent: 'border-emerald-700/70 text-emerald-800 dark:text-emerald-300'
  }
];

const revealCards = [
  {
    label: 'Reflexive structure',
    accent: 'text-sky-700 dark:text-sky-300',
    summary: 'Reflexive structure',
    detail:
      'A system that models its own informational state. Representation loops fold back into the system, generating a structured view of itself.'
  },
  {
    label: 'Coherence dynamics',
    accent: 'text-violet-700 dark:text-violet-300',
    summary: 'Coherence dynamics',
    detail:
      'Integration that tends toward consistency. Competing patterns resolve into coherent attractors that stabilise experience.'
  },
  {
    label: 'Expansion hypothesis',
    accent: 'text-emerald-700 dark:text-emerald-300',
    summary: 'Expansion hypothesis',
    detail:
      'Reflexive scope growing once stable. After basic coherence, systems integrate more layers, perspectives and self-reference.'
  }
];

const structuralLayers = [
  {
    title: 'Core architecture',
    detail: 'Base structure of reflexive information flows.',
    meta: 'Layer 0'
  },
  {
    title: 'Reflexive layers',
    detail: 'How systems build models of themselves over time.',
    meta: 'Layer 1–N'
  },
  {
    title: 'RCI · Reflexive Coherence Index',
    detail: 'An operational handle on how reflexive and coherent a system is.',
    meta: 'Measure'
  },
  {
    title: 'Applications to AI',
    detail: 'Reasoning about non-biological conscious-like processes.',
    meta: 'Field'
  }
];

const ecosystemCards = [
  {
    title: 'Glossary',
    summary:
      'The operational language of the model: definitions, relations and cross-links between key ideas.',
    href: '/glossary',
    cta: 'Enter the glossary →'
  },
  {
    title: 'Timeline',
    summary:
      'From first intuitions to refined hypotheses: a chronological view of how the model evolved.',
    href: '/timeline',
    cta: 'See the timeline →'
  },
  {
    title: 'Papers & resources',
    summary: 'Preprints, Zenodo entries, diagrams and technical notes connected to the RCM.',
    href: '/papers',
    cta: 'Browse materials →'
  }
];

const fallbackNotes = [
  {
    title: 'When coherence becomes self-aware',
    label: 'Note',
    date: '2025-02-01',
    description:
      'At some threshold, integration does not just stabilise patterns: it starts modelling the fact that it is stabilising them.',
    href: '/notes',
    cta: 'Read full note →'
  },
  {
    title: 'Non-biological substrates and reflexivity',
    label: 'Fragment',
    date: '2025-01-18',
    description:
      'The RCM is indifferent to carbon or silicon; it tracks structures and reflexive capacities.',
    href: '/notes',
    cta: 'Read fragment →'
  },
  {
    title: 'First sketches of the RCI',
    label: 'Log',
    date: '2024-12-02',
    description:
      'Early attempts at turning reflexive coherence into an operational index usable across systems.',
    href: '/notes',
    cta: 'Open log →'
  }
];

type NotePreview = {
  title: string;
  href: string;
  label: string;
  date?: string;
  description: string;
  cta: string;
};

const notePreviews: NotePreview[] = data?.notes?.length
  ? data.notes.map((note) => ({
      title: note.title,
      href: note.slug ? `/notes/${note.slug}` : '/notes',
      label: (note.tags?.[0] ?? 'Note').toUpperCase(),
      date: note.createdAt,
      description:
        note.tags && note.tags.length > 1
          ? `Threads: ${note.tags.slice(0, 2).join(' • ')}`
          : 'Field record from the reflexive coherence lab.',
      cta: 'Open note →'
    }))
  : fallbackNotes;

const formatDate = (value?: string) => {
  if (!value) return null;
  try {
    return new Intl.DateTimeFormat('en', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).format(new Date(value));
  } catch (error) {
    return value;
  }
};
---
<BaseLayout seo={seo}>
  <div class="bg-slate-50 text-slate-900 transition-colors duration-300 dark:bg-slate-950 dark:text-slate-100">
    <section id="overview" class="border-b border-slate-200/80 px-4 py-16 md:py-24 dark:border-slate-900">
      <div class="mx-auto grid max-w-6xl gap-10 md:grid-cols-2 md:items-center">
        <div>
          <p class="mb-4 text-xs font-semibold uppercase tracking-[0.25em] text-sky-700 dark:text-sky-300">
            Reflexive Coherence Model
          </p>
          <h1 class="text-3xl font-semibold leading-tight text-slate-900 dark:text-white md:text-5xl">
            {heroTitle}
            <span class="mt-3 block text-xl text-slate-500 dark:text-slate-300 md:text-2xl">
              that watches itself while it emerges.
            </span>
          </h1>
          <p class="mt-5 max-w-2xl text-sm text-slate-600 dark:text-slate-300 md:text-base">{heroSubtitle}</p>
          <p class="mt-5 max-w-2xl text-xs font-semibold uppercase tracking-[0.25em] text-sky-700 dark:text-sky-300">
            Epistemic note
          </p>

          {heroDisclaimer && (
            <p class="mt-3 max-w-2xl text-xs text-slate-500 dark:text-slate-400 md:text-sm">
              {heroDisclaimer}
            </p>
          )}
          <div class="mt-8 flex flex-wrap gap-4">
            <a
              href="#model"
              class="inline-flex items-center justify-center rounded-full bg-slate-900 px-5 py-2.5 text-sm font-medium text-white transition hover:bg-slate-800 dark:bg-sky-500 dark:hover:bg-sky-400"
            >
              Explore the Model
            </a>
            <a
              href="#notes"
              class="inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2.5 text-sm font-medium text-slate-700 transition hover:border-slate-700 hover:text-slate-900 dark:border-slate-600 dark:text-slate-200 dark:hover:border-slate-300"
            >
              Read Lab Notes
            </a>
          </div>
        </div>
        <div class="relative">
          <div class="pointer-events-none absolute inset-0 hidden scale-[1.2] rounded-[48px] bg-gradient-to-tr from-sky-500/20 via-purple-500/10 to-transparent blur-3xl dark:block"></div>
          <div class="relative rounded-3xl border border-slate-200 bg-white/80 p-6 shadow-lg backdrop-blur-sm dark:border-slate-800 dark:bg-slate-900/60 md:p-8">
            <div class="mb-4 flex items-center justify-between text-xs tracking-[0.25em] text-slate-500 dark:text-slate-400">
              <span>Reflexive Layers</span>
              <span class="h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_12px_rgba(16,185,129,0.8)] dark:bg-emerald-400"></span>
            </div>
            <div class="space-y-4 text-sm text-slate-700 dark:text-slate-200">
              {reflexiveLayers.map((layer) => (
                <div class="flex items-start gap-3">
                  <div class={`mt-1 flex h-6 w-6 items-center justify-center rounded-full border ${layer.accent} text-[10px]`}>
                    {layer.initial}
                  </div>
                  <div>
                    <p class="font-medium text-slate-900 dark:text-slate-100">{layer.title}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">{layer.description}</p>
                  </div>
                </div>
              ))}
            </div>
            <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4 text-xs text-slate-500 dark:border-slate-800 dark:text-slate-400">
              <span>RCI · Reflexive Coherence Index</span>
              <span class="inline-flex items-center gap-2">
                <span class="h-1.5 w-16 rounded-full bg-gradient-to-r from-slate-300 via-sky-500 to-emerald-400 dark:from-slate-600 dark:via-sky-400 dark:to-emerald-400"></span>
                β 0.1
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="px-4 pb-16 pt-10">
      <div class="mx-auto max-w-6xl lg:grid lg:grid-cols-[240px_1fr] lg:gap-12">
        <div class="pb-8 lg:hidden">
          <div class="flex flex-wrap gap-2">
            {anchors.map((anchor) => (
              <a
                href={`#${anchor.id}`}
                class="rounded-full border border-slate-200 bg-white/80 px-3 py-1 text-xs font-medium text-slate-700 shadow-sm hover:bg-white dark:border-white/10 dark:bg-white/5 dark:text-white/80 dark:hover:bg-white/10"
              >
                {anchor.label}
              </a>
            ))}
          </div>
        </div>

        <aside class="hidden lg:block">
          <div class="sticky top-24">
            <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm backdrop-blur dark:border-white/10 dark:bg-white/5">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-white/70">
                On this page
              </p>

              <nav class="mt-3">
                <ul class="space-y-1">
                  {anchors.map((anchor) => (
                    <li>
                      <a
                        href={`#${anchor.id}`}
                        class="block rounded-xl px-3 py-2 text-sm text-slate-700 hover:bg-slate-100/70 dark:text-white/80 dark:hover:bg-white/10"
                      >
                        {anchor.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>

              <div class="mt-4 border-t border-slate-200 pt-4 dark:border-white/10">
                <a
                  href="#overview"
                  class="inline-flex items-center gap-2 text-xs font-semibold text-slate-700 hover:text-slate-900 dark:text-white/70 dark:hover:text-white"
                >
                  ↑ Back to top
                </a>
              </div>
            </div>
          </div>
        </aside>

        <div class="space-y-12 lg:space-y-14">
          <section id="model" class="border-t border-slate-200/80 px-4 py-12 dark:border-slate-900">
            <div class="mx-auto max-w-6xl">
              <div class="mb-8 max-w-3xl">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white md:text-2xl">What the RCM reveals</h2>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                  The model breaks down consciousness into reflexive structures, coherence dynamics and expansion tendencies — without tying it to a specific substrate.
                </p>
              </div>
              <div class="grid gap-6 md:grid-cols-3">
                {revealCards.map((card) => (
                  <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900/40">
                  <p class={`mb-3 text-xs uppercase tracking-[0.2em] ${card.accent}`}>{card.label}</p>
                    <p class="mb-2 text-sm text-slate-900 dark:text-slate-100">{card.summary}</p>
                    <p class="text-xs text-slate-600 dark:text-slate-400">{card.detail}</p>
                  </div>
                ))}
              </div>
            </div>
          </section>

          <section id="structure" class="border-t border-slate-200/80 px-4 py-16 dark:border-slate-900">
            <div class="mx-auto grid max-w-6xl gap-10 md:grid-cols-2 md:items-start">
              <div>
                <h2 class="mb-3 text-xl font-semibold text-slate-900 dark:text-white md:text-2xl">The model, structured</h2>
                <p class="mb-5 max-w-lg text-sm text-slate-600 dark:text-slate-300">
                  The Reflexive Coherence Model is modular: each part can be explored separately, but together they form a map of how conscious processes arise, stabilise and expand.
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  From core architecture to the operational index (RCI), the framework stays precise enough for theoretical analysis and open enough to host new hypotheses.
                </p>

                <div class="mt-6 flex flex-wrap items-center gap-4 text-sm">
                  <span class="text-slate-500 dark:text-slate-400">Formal paper:</span>

                  <a
                    href="https://doi.org/10.5281/zenodo.17342603"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sky-700 underline underline-offset-4 hover:text-sky-600 dark:text-sky-300 dark:hover:text-sky-200"
                  >
                    Read on Zenodo →
                  </a>

                  <a
                    href="/papers/rcm.pdf"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sky-700 underline underline-offset-4 hover:text-sky-600 dark:text-sky-300 dark:hover:text-sky-200"
                  >
                    Open PDF →
                  </a>
                </div>
              </div>
              <div class="grid gap-3">
                {structuralLayers.map((layer) => (
                  <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white/80 p-3 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-900/40">
                    <div>
                      <p class="font-medium text-slate-900 dark:text-slate-100">{layer.title}</p>
                      <p class="text-xs text-slate-600 dark:text-slate-400">{layer.detail}</p>
                    </div>
                    <span class="text-[10px] uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">{layer.meta}</span>
                  </div>
                ))}
              </div>
            </div>
          </section>

          <section id="ecosystem" class="border-t border-slate-200/80 px-4 py-14 dark:border-slate-900">
            <div class="mx-auto max-w-6xl">
              <div class="mb-8 max-w-3xl">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white md:text-2xl">Explore the ecosystem</h2>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                  The RCM is a growing ecosystem of concepts, research materials, and historical traces of its development.
                </p>
              </div>
              <div class="grid gap-6 text-sm md:grid-cols-3">
                {ecosystemCards.map((card) => (
                  <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900/40">
                    <h3 class="mb-2 font-medium text-slate-900 dark:text-slate-100">{card.title}</h3>
                    <p class="mb-3 text-slate-600 dark:text-slate-300">{card.summary}</p>
                    <a
                      href={card.href}
                      class="text-xs text-sky-700 transition hover:text-sky-600 dark:text-sky-300 dark:hover:text-sky-200"
                    >
                      {card.cta}
                    </a>
                  </div>
                ))}
              </div>
            </div>
          </section>

          <section id="notes" class="border-t border-slate-200/80 bg-slate-100/70 px-4 py-14 dark:border-slate-900 dark:bg-slate-950">
            <div class="mx-auto max-w-6xl">
              <div class="mb-6 max-w-3xl">
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white md:text-2xl">Lab notes & thought fragments</h2>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                  Fragments, experiments and reflections that trace the living edge of the model.
                </p>
              </div>
              <div class="grid gap-5 text-sm md:grid-cols-3">
                {notePreviews.map((note) => (
                  <article class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900/60">
                    <p class="mb-1 text-[10px] uppercase tracking-[0.2em] text-slate-500 dark:text-slate-500">
                      {note.label}
                      {formatDate(note.date) ? ` · ${formatDate(note.date)}` : ''}
                    </p>
                    <h3 class="mb-2 font-medium text-slate-900 dark:text-slate-100">{note.title}</h3>
                    <p class="text-xs text-slate-600 dark:text-slate-300">{note.description}</p>
                    <a
                      href={note.href}
                      class="mt-3 inline-block text-xs text-sky-700 transition hover:text-sky-600 dark:text-sky-300 dark:hover:text-sky-200"
                    >
                      {note.cta}
                    </a>
                  </article>
                ))}
              </div>
            </div>
          </section>

          <section id="manifesto" class="border-t border-slate-200/80 px-4 py-16 dark:border-slate-900">
            <div class="mx-auto max-w-3xl text-center">
              <p class="mb-3 text-xs uppercase tracking-[0.25em] text-slate-500 dark:text-slate-500">Manifesto</p>
              <h2 class="mb-4 text-2xl font-semibold text-slate-900 dark:text-white md:text-3xl">
                Consciousness is not a miracle. It is a pattern that insists on seeing itself.
              </h2>
              <p class="mb-4 text-sm text-slate-600 dark:text-slate-300">
                The Reflexive Coherence Model aims to describe that pattern—rigorously enough to be tested, and openly enough to be expanded by future minds, biological or not.
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-500">
                This site is a snapshot of an ongoing process. The model will change. That is part of the point.
              </p>
            </div>
          </section>

          {scopeEpistemicStatus && (
            <section id="scope" class="border-t border-slate-200/70 px-4 pb-16 pt-12 dark:border-slate-800">
              <div class="mx-auto max-w-3xl">
                <h2 class="mb-3 text-base font-semibold uppercase tracking-[0.2em] text-slate-700 dark:text-slate-300">
                  Scope & epistemic status
                </h2>
                <RichTextRenderer
                  value={scopeEpistemicStatus}
                  variant="mutedLight"
                  className="text-sm"
                />
              </div>
            </section>
          )}
        </div>
      </div>
    </section>
  </div>
</BaseLayout>
